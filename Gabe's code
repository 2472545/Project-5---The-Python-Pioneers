import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
from matplotlib import animation
DATAFILE = r"/Users/gabri/Downloads/ECG_DATA.csv" # put your own file pathname
FS = 400 # sampling frequency

def load_ecg(path):
    df = pd.read_csv(path)
    return df
path = DATAFILE
print(load_ecg(path)) # Temporarily print to confirm data loading success

WINDOW_SIZE = 15  
def moving_average(signal, window = WINDOW_SIZE):
    kernel = np.ones(window) / window
    return np.convolve(signal, kernel, mode='same')

def filter_signal(df, window_size = WINDOW_SIZE):
    df_filtered = df.copy()
    df_filtered['Filtered Voltage'] = (df_filtered.groupby('Patient ID')['Voltage'].transform(lambda x: moving_average(x, window=window_size)))
    return df_filtered

df = pd.read_csv(DATAFILE)
df_filtered = filter_signal(df)
#create_filtered_ecg_plot(df_filtered)

# DETECT R PEAKS TODO

# COMPUTE METRICS TODO

def create_plots(df):

    # Raw ECG Plot

    plt.figure(figsize=(14,8))
    sns.lineplot(data=df,  x= 'Time', y="Voltage", hue="Patient ID", palette = 'gist_rainbow')
    plt.title("Voltage vs. Time")
    plt.savefig(r"C:\Users\gabri\OneDrive\Desktop\raw_ecg.png") # Saving in png format within the file path
    plt.xlim(0, 10)
    plt.show()
    plt.close()

    # Filtered ecg

    plt.figure(figsize=(14,8))
    sns.lineplot(data=df_filtered, x='Time', y="Filtered Voltage", hue="Patient ID", palette='gist_rainbow') 
    plt.title("Filtered ECG Signals (Moving Average Smoothing)")
    plt.xlabel("Time (s)")
    plt.ylabel("Voltage (mV)")
    plt.xlim(df_filtered['Time'].min(), df_filtered['Time'].min() + 10)  # safer limit
    plt.savefig(r"/Users/gabri/Downloads/ECG_DATA.png")
    plt.show()
    plt.close()

    # RR Scatter

    # HR histogram


create_plots(load_ecg(path))
# TODO filtered_ecg.png
# TODO rr_scatter.png
# TODO hr_hist.png


def make_animation(df):
    ecg_data = df.groupby("Time")["Voltage"].mean().reset_index()
    times = ecg_data["Time"].values
    voltage = ecg_data["Voltage"].values

    fig, ax = plt.subplots(figsize=(12,12))
    ax.set_facecolor('black')
    ax.grid(True)
    ax.set_xlim(min(times), max(times))
    ax.set_ylim(min(voltage), max(voltage) + 2)

    line, = ax.plot([], [], '-', color = 'lime', lw = 2)
    print(line)

# NOT SURE IF THIS IS THE ANIMATION HE WANTS; WE CAN ASK HIM ON TUESDAY

    def animate(i):
        window = 400 # Sampling frequency
        start = max(0, i - window)
        x = times[:i]
        y = voltage[:i]
        line.set_data(x, y)
        ax.set_xlim(times[start], times[i])
        ax.set_title(f"Time: {i} s")
        return line,

    anim = animation.FuncAnimation(fig, animate, frames=len(times), interval = 1)
    plt.xlabel("Time (s)")
    plt.ylabel("Voltage (mV)")
    plt.show()
    anim.save(r"C:\Users\gabri\OneDrive\Desktop\ecg_scrolling.gif")
    plt.close()

print(make_animation(df))
def export_results(df):
# TODO ecg_summary.csv and rr_intervals.csv
    pass
#if __name__ == "__main__":
    #df = load_ecg(DATAFILE)
    #df = filter_signal(df)
    #df = detect_r_peaks(df)
    #create_plots(df)
    # Animation
    #print("Complete all TODOs!")

