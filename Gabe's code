import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
from matplotlib import animation
DATAFILE = r"/Users/gabri/Downloads/ECG_DATA.csv" # put your own file pathname
FS = 400 # sampling frequency

def load_ecg(path):
    df = pd.read_csv(path)
    return df
path = DATAFILE
print(load_ecg(path)) # Temporarily print to confirm data loading success

WINDOW_SIZE = 15  
def moving_average(signal, window = WINDOW_SIZE):
    kernel = np.ones(window) / window
    return np.convolve(signal, kernel, mode='same')

def filter_signal(df, window_size = WINDOW_SIZE):
    df_filtered = df.copy()
    df_filtered['Filtered Voltage'] = (
        df_filtered.groupby('Patient ID')['Voltage']
        .transform(lambda x: moving_average(x, window=window_size)))
    return df_filtered

df = pd.read_csv(DATAFILE)
df_filtered = filter_signal(df)
#create_filtered_ecg_plot(df_filtered)

def create_plots(df):

    # Raw ECG Plot

    plt.figure(figsize=(14,8))
    sns.lineplot(data=df,  x= 'Time', y="Voltage", hue="Patient ID", palette = 'gist_rainbow')
    plt.title("Voltage vs. Time")
    plt.savefig(r"C:\Users\gabri\OneDrive\Desktop\raw_ecg.png") # Saving in png format within the file path
    plt.xlim(0, 10)
    plt.show()
    plt.close()

    # Filtered ecg

    plt.figure(figsize=(14,8))
    sns.lineplot(data=df_filtered, x='Time', y="Filtered Voltage", hue="Patient ID", palette='gist_rainbow') 
    plt.title("Filtered ECG Signals (Moving Average Smoothing)")
    plt.xlabel("Time (s)")
    plt.ylabel("Voltage (mV)")
    plt.xlim(df_filtered['Time'].min(), df_filtered['Time'].min() + 10)  # safer limit
    plt.savefig(r"/Users/gabri/Downloads/ECG_DATA.png")
    plt.show()
    plt.close()

    # RR Scatter

    # HR histogram


create_plots(load_ecg(path))
# TODO filtered_ecg.png
# TODO rr_scatter.png
# TODO hr_hist.png


def make_animation(df):
# TODO horizontal scrolling ECG animation
    pass
def export_results(df):
# TODO ecg_summary.csv and rr_intervals.csv
    pass
#if __name__ == "__main__":
    #df = load_ecg(DATAFILE)
    #df = filter_signal(df)
    #df = detect_r_peaks(df)
    #create_plots(df)
    # Animation
    #print("Complete all TODOs!")

